function Export-IntuneAppProtectionPolicies { [CmdletBinding()] param([string]$ReportPath)
  Write-Log -Message 'Exporting Intune App Protection Policies (MAM)...' -Level INFO
  $pols=@(); $rows=@(); $bundle=@(); try { $resp = Invoke-MgGraphRequest -Method GET -Uri 'https://graph.microsoft.com/v1.0/deviceAppManagement/managedAppPolicies'; $pols=@($resp.value) } catch {}
  foreach($p in $pols){ $pid=$p.id; $ptype=$p.'@odata.type'; $assign=@(); try { $ar = Invoke-MgGraphRequest -Method GET -Uri ("https://graph.microsoft.com/beta/deviceAppManagement/managedAppPolicies/{0}/assignments" -f $pid); $assign=@($ar.value) } catch {}; $apps=@(); try { $appr = Invoke-MgGraphRequest -Method GET -Uri ("https://graph.microsoft.com/v1.0/deviceAppManagement/managedAppPolicies/{0}/apps" -f $pid); $apps=@($appr.value) } catch {}; $bundle += [pscustomobject]@{ Policy=$p; Assignments=$assign; Apps=$apps }; $platform = if ($ptype -like '*iosManagedAppProtection*'){'iOS/iPadOS'} elseif ($ptype -like '*androidManagedAppProtection*'){'Android'} elseif ($ptype -like '*windows*'){'Windows'} else {'Unknown'}; $rows += [pscustomobject]@{ Id=$pid; DisplayName=$p.displayName; Type=$ptype; Platform=$platform; MinimumPinLength=$p.minimumPinLength; PinRequired=$p.pinRequired; AllowedOutboundDataTransferDestinations=$p.allowedOutboundDataTransferDestinations; DataBackupBlocked=$p.dataBackupBlocked; SaveAsBlocked=$p.saveAsBlocked; ScreenCaptureBlocked=$p.screenCaptureBlocked; IsAssigned=[bool]($assign.Count -gt 0); AssignmentCount=$assign.Count; TargetedAppCount=$apps.Count } }
  $int = Write-IntermediateJson -Name 'intune-app-protection' -Data $bundle -ReportPath $ReportPath
  $paths = Out-ReportFiles -BaseName 'intune-app-protection' -Data $rows -ReportPath $ReportPath -Title 'Intune App Protection Policies' -Intro 'MAM deep dive.'
  [pscustomobject]@{ Data=$bundle; Intermediate=$int; Paths=$paths }
}
